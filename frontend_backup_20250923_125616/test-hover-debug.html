<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hover Preview Debug</title>
  <style>
    body {
      background: #000;
      color: #0f0;
      font-family: monospace;
      padding: 20px;
    }

    .debug-section {
      border: 1px solid #0f0;
      padding: 10px;
      margin: 20px 0;
    }

    .video-test {
      width: 300px;
      height: 200px;
      border: 1px solid #0f0;
      position: relative;
      display: inline-block;
      margin: 10px;
    }

    .video-test video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    pre {
      background: #111;
      padding: 10px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>Hover Preview Debug Tool</h1>

  <div class="debug-section">
    <h2>1. API Status</h2>
    <div id="api-status">Checking...</div>
  </div>

  <div class="debug-section">
    <h2>2. Gallery Data URLs</h2>
    <pre id="data-urls">Loading...</pre>
  </div>

  <div class="debug-section">
    <h2>3. Direct Video Test</h2>
    <div id="video-tests"></div>
  </div>

  <div class="debug-section">
    <h2>4. Console Logs</h2>
    <pre id="console-logs"></pre>
  </div>

  <script src="config.js"></script>
  <script>
    const logs = [];
    const originalLog = console.log;
    const originalError = console.error;

    console.log = function(...args) {
      originalLog.apply(console, args);
      logs.push('[LOG] ' + args.join(' '));
      updateLogs();
    };

    console.error = function(...args) {
      originalError.apply(console, args);
      logs.push('[ERROR] ' + args.join(' '));
      updateLogs();
    };

    function updateLogs() {
      const logsEl = document.getElementById('console-logs');
      if (logsEl) {
        logsEl.textContent = logs.slice(-20).join('\n');
      }
    }

    async function runTests() {
      // Test 1: API Status
      const statusEl = document.getElementById('api-status');
      try {
        const response = await fetch(`${window.API_URL}/health`);
        const health = await response.json();
        statusEl.innerHTML = `✅ API is running on ${window.API_URL}<br>Uptime: ${health.uptime_seconds}s`;
      } catch (err) {
        statusEl.innerHTML = `❌ API not responding: ${err.message}`;
      }

      // Test 2: Gallery Data
      const urlsEl = document.getElementById('data-urls');
      try {
        const response = await fetch(`${window.API_URL}/api/gallery`);
        const data = await response.json();

        if (data.videos && data.videos.length > 0) {
          const firstVideo = data.videos[0];
          urlsEl.textContent = JSON.stringify({
            id: firstVideo.id,
            thumbnail: firstVideo.thumbnail,
            preview: firstVideo.preview,
            full: firstVideo.full,
            category: firstVideo.category
          }, null, 2);

          // Test 3: Direct Video Loading
          const testsEl = document.getElementById('video-tests');
          testsEl.innerHTML = '<p>Testing first video preview URL...</p>';

          // Construct full URL if needed
          let previewUrl = firstVideo.preview;
          if (previewUrl.startsWith('/api/')) {
            previewUrl = `${window.API_URL}${previewUrl}`;
          }

          const testDiv = document.createElement('div');
          testDiv.className = 'video-test';
          testDiv.innerHTML = `
            <video controls muted autoplay loop>
              <source src="${previewUrl}" type="video/mp4">
            </video>
            <p>URL: ${previewUrl}</p>
          `;
          testsEl.appendChild(testDiv);

          const video = testDiv.querySelector('video');
          video.addEventListener('loadedmetadata', () => {
            console.log('Video metadata loaded successfully');
          });
          video.addEventListener('canplay', () => {
            console.log('Video can play!');
          });
          video.addEventListener('error', (e) => {
            console.error('Video error:', e);
            console.error('Video error detail:', video.error);
          });

        } else {
          urlsEl.textContent = 'No videos found in gallery data';
        }
      } catch (err) {
        urlsEl.textContent = `Error loading gallery: ${err.message}`;
      }
    }

    // Run tests on load
    window.addEventListener('DOMContentLoaded', runTests);
  </script>
</body>
</html>
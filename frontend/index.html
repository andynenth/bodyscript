<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BodyScript - AI Pose Detection for Videos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .drop-zone {
            transition: all 0.3s ease;
        }
        .drop-zone.dragover {
            background-color: #dbeafe;
            border-color: #2563eb;
        }
        .skeleton-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                ðŸŽ¬ BodyScript Pose Detection
            </h1>
            <p class="text-gray-600">
                Upload a video to detect and visualize human poses using AI
            </p>
            <div class="mt-4 space-x-4 text-sm">
                <span class="text-gray-500">Portfolio MVP</span>
                <a href="https://github.com/yourusername/bodyscript" target="_blank"
                   class="text-blue-600 hover:underline">GitHub</a>
            </div>
        </header>

        <!-- Main Content -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <!-- Upload Section -->
            <div id="uploadSection">
                <div id="dropZone"
                     class="drop-zone border-2 border-dashed border-gray-300 rounded-lg p-12 text-center cursor-pointer hover:border-gray-400">
                    <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    <p class="text-lg text-gray-600 mb-2">Drop your video here or click to browse</p>
                    <p class="text-sm text-gray-500">Maximum 15 seconds (longer videos will be trimmed)</p>
                    <p class="text-xs text-gray-400 mt-2">Supported: MP4, AVI, MOV, MKV</p>
                    <input type="file" id="fileInput" accept="video/*" class="hidden">
                </div>

                <!-- File Info -->
                <div id="fileInfo" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold text-gray-700" id="fileName"></p>
                            <p class="text-sm text-gray-500" id="fileSize"></p>
                        </div>
                        <button id="clearBtn" class="text-red-600 hover:text-red-700 text-sm">
                            Remove
                        </button>
                    </div>
                </div>

                <!-- Upload Button -->
                <button id="uploadBtn"
                        class="hidden mt-4 w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 transition">
                    Start Processing
                </button>
            </div>

            <!-- Processing Section -->
            <div id="processingSection" class="hidden">
                <div class="text-center py-8">
                    <!-- Skeleton Animation -->
                    <div class="skeleton-animation mb-6">
                        <svg class="w-24 h-24 mx-auto text-blue-600" fill="none" viewBox="0 0 24 24">
                            <circle cx="12" cy="4" r="2" stroke="currentColor" stroke-width="2"/>
                            <path stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                  d="M12 6v6m0 0l-4 8m4-8l4 8m-4-8l-4-4m4 4l4-4"/>
                        </svg>
                    </div>

                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Processing Your Video</h3>

                    <!-- Queue Status -->
                    <div id="queueStatus" class="mb-4">
                        <p class="text-sm text-gray-600">
                            Queue Position: <span id="queuePosition" class="font-bold">1</span> of
                            <span id="queueTotal" class="font-bold">1</span>
                        </p>
                    </div>

                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                        <div id="progressBar" class="bg-blue-600 h-3 rounded-full transition-all duration-300"
                             style="width: 0%"></div>
                    </div>
                    <p id="progressText" class="text-sm text-gray-600 mb-2">0% Complete</p>
                    <p id="progressMessage" class="text-xs text-gray-500"></p>

                    <!-- Time Estimate -->
                    <p class="text-sm text-gray-500 mt-4">
                        Estimated time: 2-3 minutes for 15 seconds of video
                    </p>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden">
                <div class="text-center py-6">
                    <svg class="w-16 h-16 mx-auto text-green-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Processing Complete!</h3>

                    <!-- Statistics -->
                    <div id="statistics" class="grid grid-cols-2 gap-4 mb-6 text-left max-w-md mx-auto">
                        <div class="bg-gray-50 p-3 rounded">
                            <p class="text-xs text-gray-500">Frames Processed</p>
                            <p class="font-semibold" id="framesProcessed">-</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <p class="text-xs text-gray-500">Detection Quality</p>
                            <p class="font-semibold" id="detectionQuality">-</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <p class="text-xs text-gray-500">Processing Time</p>
                            <p class="font-semibold" id="processingTime">-</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <p class="text-xs text-gray-500">Processing Mode</p>
                            <p class="font-semibold" id="processingMode">-</p>
                        </div>
                    </div>

                    <!-- Download Buttons -->
                    <div class="space-y-3">
                        <a id="downloadVideo"
                           class="block w-full bg-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-green-700 transition">
                            ðŸ“¹ Download Video with Skeleton Overlay
                        </a>
                        <a id="downloadCSV"
                           class="block w-full bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700 transition">
                            ðŸ“Š Download Pose Data (CSV)
                        </a>
                        <button id="processAnother"
                                class="block w-full text-blue-600 py-2 px-4 rounded-lg border border-blue-600 hover:bg-blue-50 transition">
                            Process Another Video
                        </button>
                    </div>
                </div>
            </div>

            <!-- Error Section -->
            <div id="errorSection" class="hidden">
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-red-600 mt-0.5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div>
                            <h4 class="font-semibold text-red-800">Processing Error</h4>
                            <p id="errorMessage" class="text-sm text-red-700 mt-1"></p>
                            <button id="tryAgain"
                                    class="mt-3 text-sm text-red-600 hover:text-red-700 underline">
                                Try Again
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Section -->
        <div class="mt-8 grid md:grid-cols-3 gap-4">
            <div class="bg-white rounded-lg shadow p-4">
                <h4 class="font-semibold text-gray-800 mb-2">ðŸš€ Fast Processing</h4>
                <p class="text-sm text-gray-600">
                    Processes videos in 2-3 minutes using optimized MediaPipe models
                </p>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <h4 class="font-semibold text-gray-800 mb-2">ðŸŽ¯ High Accuracy</h4>
                <p class="text-sm text-gray-600">
                    Detects 33 body landmarks with 87-95% accuracy
                </p>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <h4 class="font-semibold text-gray-800 mb-2">ðŸ’° Low Cost</h4>
                <p class="text-sm text-gray-600">
                    Running on free tier services, costs less than $1/month
                </p>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>Built with FastAPI, MediaPipe, and React</p>
            <p class="mt-1">Â© 2025 BodyScript - Portfolio Project</p>
        </footer>
    </div>

    <script>
        // Configuration
        const API_URL = 'http://localhost:8000';
        let currentJobId = null;
        let statusCheckInterval = null;

        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const clearBtn = document.getElementById('clearBtn');
        const processAnother = document.getElementById('processAnother');
        const tryAgain = document.getElementById('tryAgain');

        // Sections
        const uploadSection = document.getElementById('uploadSection');
        const processingSection = document.getElementById('processingSection');
        const resultsSection = document.getElementById('resultsSection');
        const errorSection = document.getElementById('errorSection');

        // File handling
        let selectedFile = null;

        // Event Listeners
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        uploadBtn.addEventListener('click', uploadVideo);
        clearBtn.addEventListener('click', clearFile);
        processAnother.addEventListener('click', reset);
        tryAgain.addEventListener('click', reset);

        // Functions
        function handleFileSelect(file) {
            // Validate file type
            const validTypes = ['video/mp4', 'video/avi', 'video/quicktime', 'video/x-matroska'];
            if (!validTypes.includes(file.type) && !file.name.match(/\.(mp4|avi|mov|mkv)$/i)) {
                showError('Please select a valid video file (MP4, AVI, MOV, MKV)');
                return;
            }

            selectedFile = file;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileInfo').classList.remove('hidden');
            uploadBtn.classList.remove('hidden');
        }

        function clearFile() {
            selectedFile = null;
            fileInput.value = '';
            document.getElementById('fileInfo').classList.add('hidden');
            uploadBtn.classList.add('hidden');
        }

        async function uploadVideo() {
            if (!selectedFile) return;

            // Show processing section
            uploadSection.classList.add('hidden');
            processingSection.classList.remove('hidden');
            errorSection.classList.add('hidden');

            try {
                // Create form data
                const formData = new FormData();
                formData.append('file', selectedFile);

                // Upload video
                const response = await fetch(`${API_URL}/api/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Upload failed');
                }

                const data = await response.json();
                currentJobId = data.job_id;

                // Start polling for status
                startStatusPolling();

            } catch (error) {
                showError(error.message);
            }
        }

        function startStatusPolling() {
            statusCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_URL}/api/status/${currentJobId}`);
                    const status = await response.json();

                    updateProgress(status);

                    if (status.status === 'completed') {
                        clearInterval(statusCheckInterval);
                        showResults(status);
                    } else if (status.status === 'failed') {
                        clearInterval(statusCheckInterval);
                        showError(status.error || 'Processing failed');
                    }
                } catch (error) {
                    clearInterval(statusCheckInterval);
                    showError('Failed to check status');
                }
            }, 2000); // Check every 2 seconds
        }

        function updateProgress(status) {
            const progress = status.progress || 0;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `${progress}% Complete`;
            document.getElementById('progressMessage').textContent = status.message || '';

            // Update queue position if pending
            if (status.queue_position) {
                document.getElementById('queuePosition').textContent = status.queue_position;
                document.getElementById('queueTotal').textContent = status.queue_total || 1;
                document.getElementById('queueStatus').classList.remove('hidden');
            } else {
                document.getElementById('queueStatus').classList.add('hidden');
            }
        }

        function showResults(status) {
            processingSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');

            // Display statistics
            const stats = status.statistics || {};
            document.getElementById('framesProcessed').textContent = stats.frames_processed || '-';
            document.getElementById('detectionQuality').textContent =
                stats.average_quality ? `${(stats.average_quality * 100).toFixed(1)}%` : '-';
            document.getElementById('processingTime').textContent =
                stats.processing_time ? `${stats.processing_time.toFixed(1)}s` : '-';
            document.getElementById('processingMode').textContent =
                (stats.processing_mode || 'fast').toUpperCase();

            // Set download links
            document.getElementById('downloadVideo').href =
                `${API_URL}/api/download/${currentJobId}/video`;
            document.getElementById('downloadCSV').href =
                `${API_URL}/api/download/${currentJobId}/csv`;
        }

        function showError(message) {
            uploadSection.classList.add('hidden');
            processingSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            errorSection.classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        function reset() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            currentJobId = null;
            selectedFile = null;
            fileInput.value = '';

            uploadSection.classList.remove('hidden');
            processingSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            errorSection.classList.add('hidden');

            document.getElementById('fileInfo').classList.add('hidden');
            uploadBtn.classList.add('hidden');
            document.getElementById('progressBar').style.width = '0%';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Wake up service notification
        async function checkHealth() {
            try {
                const response = await fetch(`${API_URL}/health`);
                if (response.ok) {
                    console.log('API is running');
                } else {
                    console.warn('API may be sleeping. First upload will wake it up.');
                }
            } catch (error) {
                console.warn('API is not running or sleeping. Please start the backend server.');
            }
        }

        // Check API health on page load
        checkHealth();
    </script>
</body>
</html>
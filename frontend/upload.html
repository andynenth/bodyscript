<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BodyScript Terminal - Upload Video</title>

  <!-- Terminal font -->
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Configuration -->
  <script src="config.js"></script>

  <!-- Common styles -->
  <link rel="stylesheet" href="assets/gallery-common.css">

  <!-- Terminal upload styles -->
  <style>
    /* Terminal Theme */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      background: #0a0a0a;
      color: var(--text-terminal-green);
      min-height: 100vh;
      padding: 2rem;
      background-image:
        repeating-linear-gradient(0deg, transparent, transparent 20px, rgba(0, 255, 0, 0.01) 20px, rgba(0, 255, 0, 0.01) 21px),
        repeating-linear-gradient(90deg, transparent, transparent 20px, rgba(0, 255, 0, 0.01) 20px, rgba(0, 255, 0, 0.01) 21px);
    }

    .terminal-container {
      max-width: 900px;
      margin: 0 auto;
    }

    /* Terminal Window */
    .terminal-window {
      background: var(--bg-terminal);
      border: 1px solid var(--border-secondary);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .terminal-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 1rem;
      background: var(--bg-terminal-header);
      border-bottom: 1px solid var(--border-secondary);
    }

    .terminal-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .terminal-dot.red { background: #ff5f56; }
    .terminal-dot.yellow { background: #ffbd2e; }
    .terminal-dot.green { background: #27c93f; }

    .terminal-title {
      flex: 1;
      text-align: center;
      color: var(--text-secondary);  /* Changed from text-muted (#666) to text-secondary (#b0b0b0) for better contrast */
      font-size: 0.9rem;
    }

    /* Terminal Body */
    .terminal-body {
      padding: 2rem;
      min-height: 600px;
    }


    /* ASCII Drop Zone - Smaller and Centered */
    .ascii-dropzone {
      margin: 2rem auto;
      padding: 2rem 1.5rem;
      border: 2px dashed var(--border-secondary);
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
      position: relative;
      max-width: 400px;
      transform: scale(0.9);
    }

    .ascii-dropzone:hover {
      border-color: var(--border-secondary);  /* Keep the same gray border on hover */
      background: rgba(255, 255, 255, 0.05);  /* Same subtle white highlight as details-toggle */
      transform: scale(1);
    }

    .ascii-dropzone.dragover {
      border-color: var(--text-terminal-green);
      background: rgba(39, 201, 63, 0.1);
      box-shadow: 0 0 20px rgba(39, 201, 63, 0.2);
      transform: scale(1.02);
    }

    .ascii-dropzone.has-file {
      display: none !important;
    }

    .ascii-art {
      color: #27c93f;  /* Explicit bright green color */
      font-size: 0.9rem;
      line-height: 1.2;
      margin-bottom: 1rem;
      opacity: 1;  /* Full opacity for better visibility */
      white-space: pre;
      font-family: 'JetBrains Mono', monospace;
    }

    .drop-text {
      color: var(--text-primary);  /* Changed from text-secondary to text-primary for better visibility */
      margin-top: 1rem;
      font-size: 14px;
    }

    .file-input {
      display: none;
    }

    .terminal-btn {
      display: inline-block;
      margin-top: 1rem;
      padding: 0.75rem 1.5rem;
      background: rgba(39, 201, 63, 0.1);  /* Subtle green background for better visibility */
      border: 1px solid #27c93f;  /* Bright green border */
      color: #27c93f;  /* Bright green text */
      text-transform: uppercase;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .terminal-btn:hover {
      background: #27c93f;  /* Solid green on hover */
      color: #000;  /* Black text on hover for contrast */
      box-shadow: 0 0 20px rgba(39, 201, 63, 0.3);
      transform: translateY(-2px);  /* Slight lift effect */
    }

    /* File Display - Reorganized */
    .file-display {
      display: none;
      margin: 2rem auto;
      max-width: 600px;
      background: rgba(0, 0, 0, 0.3);  /* Consistent with system-info background */
      border: 1px solid var(--border-secondary);  /* Consistent border color */
      border-radius: 4px;  /* Consistent with other components */
      overflow: hidden;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .file-display.show {
      display: block;
    }

    .file-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: transparent;  /* Simplified background */
      border-bottom: 1px solid var(--border-secondary);
    }

    .file-main-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .file-name {
      color: #27c93f;  /* Green for file name to stand out */
      font-size: 14px;  /* Consistent font size */
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
    }

    .file-size {
      color: var(--text-primary);
      font-size: 14px;  /* Consistent font size */
      font-family: 'JetBrains Mono', monospace;
    }

    .remove-btn {
      padding: 0.5rem 0.75rem;
      border-radius: 4px;  /* Square like other buttons */
      border: 1px solid #ff5f56;
      background: rgba(255, 95, 86, 0.1);
      color: #ff5f56;
      font-size: 14px;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
    }

    .remove-btn:hover {
      background: #ff5f56;
      color: #000;  /* Black text on hover for contrast */
      transform: translateY(-2px);  /* Consistent with other buttons */
    }

    .details-toggle {
      width: 100%;
      padding: 0.75rem 1rem;
      background: transparent;
      border: none;
      border-bottom: 1px solid var(--border-secondary);
      color: var(--text-primary);
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;  /* Consistent font size */
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s;
    }

    .details-toggle:hover {
      background: rgba(255, 255, 255, 0.05);  /* Subtle white highlight instead of green */
      color: var(--text-primary);  /* Keep text the same light gray color */
    }

    .toggle-icon {
      transition: transform 0.3s ease;
      display: inline-block;
    }

    .details-toggle.expanded .toggle-icon {
      transform: rotate(180deg);
    }

    .file-details {
      padding: 1rem;
      background: transparent;
      animation: expand 0.3s ease;
    }

    @keyframes expand {
      from { opacity: 0; max-height: 0; }
      to { opacity: 1; max-height: 200px; }
    }

    .file-info-line {
      color: var(--text-primary);
      margin: 0.5rem 0;
      font-size: 14px;  /* Consistent font size */
      font-family: 'JetBrains Mono', monospace;
      display: flex;
      justify-content: space-between;
    }

    .file-info-label {
      color: #27c93f;  /* Explicit green color */
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
    }

    /* System Info */
    .system-info {
      margin: 1rem 0 2rem 0;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-secondary);
      border-radius: 4px;
    }

    .info-header {
      color: #27c93f;  /* Explicit bright green instead of variable to ensure visibility */
      margin-bottom: 0.5rem;
      font-weight: 600;
      font-size: 14px;
    }

    .info-item {
      color: var(--text-primary);  /* Changed from text-secondary to text-primary for better readability */
      font-size: 14px;
      margin: 0.25rem 0;
      padding-left: 1rem;
    }

    /* Terminal Output */
    .terminal-output {
      margin-top: 2rem;
      max-height: 400px;
      overflow-y: auto;
      font-size: 0.9rem;
    }

    .output-line {
      margin: 0.25rem 0;
      color: var(--text-primary);  /* Changed from text-secondary to text-primary for better visibility */
      min-height: 1.2em;
    }

    .output-line.success {
      color: var(--text-terminal-green);
    }

    .output-line.error {
      color: #ff5f56;
    }

    .output-line.warning {
      color: #ffbd2e;
    }

    .output-line.processing::before {
      content: '>';
      margin-right: 0.5rem;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Processing Animation */
    .processing-animation {
      margin: 2rem auto;
      max-width: 600px;
      padding: 1.5rem;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-secondary);
      border-radius: 4px;
    }

    .processing-animation.show {
      display: block !important;
    }

    /* ASCII Progress Bar */
    .ascii-progress {
      margin: 1rem 0;
      font-family: 'JetBrains Mono', monospace;
    }

    .progress-label {
      color: #27c93f;  /* Bright green for visibility */
      font-size: 14px;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .progress-bar-ascii {
      color: #27c93f;  /* Bright green progress bar */
      font-size: 14px;
      font-family: 'JetBrains Mono', monospace;
      letter-spacing: -1px;
    }

    .progress-percent {
      color: #27c93f;  /* Bright green percentage */
      margin-left: 1rem;
      font-weight: 600;
      font-size: 14px;
    }

    .frame-counter {
      color: var(--text-primary);
      font-size: 14px;
      margin-top: 0.5rem;
      font-family: 'JetBrains Mono', monospace;
    }

    /* Hidden state utility */
    .hidden {
      display: none !important;
    }

    /* Process button container */
    .process-btn-container {
      text-align: center;
      margin: 2rem 0;
      display: flex;
      justify-content: center;
    }

    /* Status ready text */
    .status-ready {
      color: #27c93f;
    }

    .spinner-ascii {
      color: var(--text-terminal-green);
      font-size: 1rem;
      animation: spin-ascii 0.8s steps(4) infinite;
      display: inline-block;
    }

    @keyframes spin-ascii {
      0% { content: '|'; }
      25% { content: '/'; }
      50% { content: '-'; }
      75% { content: '\\'; }
      100% { content: '|'; }
    }

    /* Results */
    .results-section {
      display: none;
      margin-top: 2rem;
      padding: 1.5rem;
      background: transparent;
      border: 1px solid var(--border-secondary);
      border-radius: 0;  /* Square corners for terminal style */
    }

    .results-section.show {
      display: block;
    }

    .results-title {
      color: var(--text-terminal-green);
      font-size: 14px;  /* Consistent font size */
      margin-bottom: 1.5rem;
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
      text-transform: uppercase;
    }

    /* Video Player - Fixed size like test-hover-debug.html */
    .video-player-container {
      margin: 2rem auto;
      width: 300px;
      height: 200px;
      background: #000;
      border: 1px solid var(--text-terminal-green);
      overflow: hidden;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .result-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      background: #000;
    }

    .video-controls-info {
      padding: 1rem;
      background: rgba(39, 201, 63, 0.1);
      border-top: 1px solid var(--border-secondary);
    }

    .video-label {
      color: var(--text-primary);  /* Changed from text-secondary to text-primary for better contrast */
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .video-label::before {
      content: '▶';
      color: var(--text-terminal-green);
    }

    /* Result Stats */
    .result-stats {
      margin-top: 2rem;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
    }

    .result-item {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem;
      background: transparent;
      border: 1px solid var(--border-secondary);
      border-radius: 0;  /* Square for terminal style */
      color: var(--text-primary);
    }

    .result-value {
      color: var(--text-terminal-green);
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
    }

    .download-section {
      margin-top: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .button-group {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    /* Terminal-style Action Buttons */
    .action-btn {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: 1px solid var(--text-terminal-green);
      color: var(--text-terminal-green);
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      font-size: 14px;  /* Consistent font size */
      cursor: pointer;
      transition: all 0.2s ease;
      border-radius: 0;  /* Square for terminal style */
      display: flex;
      align-items: center;
      gap: 0.75rem;
      min-width: 150px;
      justify-content: center;
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
    }

    .action-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(39, 201, 63, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .action-btn:hover::before {
      left: 100%;
    }

    .action-btn:hover {
      background: rgba(39, 201, 63, 0.1);
      transform: translateY(-2px);
    }

    .action-btn:active {
      transform: translateY(0);
    }

    .btn-icon {
      flex-shrink: 0;
    }

    .download-btn {
      background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(52, 152, 219, 0.05));
      border-color: #3498db;
      color: #3498db;
    }

    .download-btn:hover {
      background: linear-gradient(135deg, rgba(52, 152, 219, 0.2), rgba(52, 152, 219, 0.1));
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }

    .reset-btn {
      background: linear-gradient(135deg, rgba(255, 189, 46, 0.1), rgba(255, 189, 46, 0.05));
      border-color: #ffbd2e;
      color: #ffbd2e;
    }

    .reset-btn:hover {
      background: linear-gradient(135deg, rgba(255, 189, 46, 0.2), rgba(255, 189, 46, 0.1));
      box-shadow: 0 4px 12px rgba(255, 189, 46, 0.3);
    }

    /* Process Button - Consistent with page style */
    .process-btn {
      padding: 0.85rem 2rem;
      background: rgba(39, 201, 63, 0.1);  /* Subtle green background like other buttons */
      border: 1px solid #27c93f;  /* Green border */
      color: #27c93f;  /* Green text */
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 4px;
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 0 auto;
      position: relative;
    }

    .process-btn:hover:not(:disabled) {
      background: #27c93f;  /* Solid green on hover */
      color: #000;  /* Black text for contrast */
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(39, 201, 63, 0.3);
    }

    .process-btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .process-btn:disabled {
      background: rgba(100, 100, 100, 0.1);
      border-color: #666;
      color: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }


    /* ASCII Logo */
    .ascii-logo-small {
      color: var(--text-terminal-green);
      font-size: 0.7rem;
      line-height: 1;
      opacity: 0.6;
      margin-bottom: 1rem;
      white-space: pre;
    }


    /* Responsive */
    @media (max-width: 768px) {
      .terminal-body {
        padding: 1rem;
      }

      .ascii-art {
        font-size: 0.7rem;
      }

      .download-section {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="terminal-container">
    <!-- Terminal Window -->
    <div class="terminal-window">
      <!-- Terminal Header -->
      <div class="terminal-header">
        <div class="terminal-dot red"></div>
        <div class="terminal-dot yellow"></div>
        <div class="terminal-dot green"></div>
        <div class="terminal-title">bodyscript@upload:~/video</div>
      </div>

      <!-- Terminal Body -->
      <div class="terminal-body">
        <!-- System Requirements at the top -->
        <div class="system-info">
          <div class="info-header">SYSTEM REQUIREMENTS:</div>
          <div class="info-item">[✓] Video format: MP4/MOV/AVI</div>
          <div class="info-item">[✓] Maximum size: 50MB</div>
          <div class="info-item">[✓] Maximum duration: 15 seconds</div>
          <div class="info-item">[✓] Minimum resolution: 480p</div>
          <div class="info-item">[✓] Clear human subjects visible</div>
        </div>


        <!-- Terminal Output (hidden by default for cleaner UI) -->
        <div class="terminal-output hidden" id="terminalOutput"></div>

        <!-- ASCII Drop Zone -->
        <div class="ascii-dropzone" id="dropZone">
          <pre class="ascii-art">
    ╭─────────────────────────╮
    │                         │
    │       DROP VIDEO        │
    │         HERE            │
    │                         │
    │    ╱│、                 │
    │   (°､ ｡ 7              │
    │    |、  ~ヽ              │
    │    じしf_,)ノ           │
    │                         │
    ╰─────────────────────────╯</pre>
          <div class="drop-text">
            SUPPORTED FORMATS: MP4, MOV, AVI<br>
            MAX SIZE: 50MB | MAX DURATION: 15s
          </div>
          <label>
            <input type="file" class="file-input" id="fileInput" accept="video/mp4,video/quicktime,video/x-msvideo">
            <span class="terminal-btn">[SELECT FILE]</span>
          </label>
        </div>

        <!-- File Display (Reorganized) -->
        <div class="file-display" id="fileDisplay">
          <div class="file-header">
            <div class="file-main-info">
              <span class="file-name" id="fileName">video.mp4</span>
              <span class="file-size" id="fileSize">5.2 MB</span>
            </div>
            <button class="remove-btn" id="removeBtn">REMOVE</button>
          </div>

          <button class="details-toggle" id="detailsToggle">
            <span class="toggle-icon">▼</span> Show Details
          </button>

          <div class="file-details hidden" id="fileDetails">
            <div class="file-info-line">
              <span class="file-info-label">Duration:</span>
              <span id="fileDuration">--:--</span>
            </div>
            <div class="file-info-line">
              <span class="file-info-label">Resolution:</span>
              <span id="fileResolution">----x----</span>
            </div>
            <div class="file-info-line">
              <span class="file-info-label">Frame Rate:</span>
              <span id="fileFrameRate">-- fps</span>
            </div>
            <div class="file-info-line">
              <span class="file-info-label">Status:</span>
              <span class="status-ready">Ready for processing</span>
            </div>
          </div>
        </div>


        <!-- Process Button -->
        <div class="process-btn-container" id="processBtnContainer">
          <button class="process-btn hidden" id="processBtn">
            <svg class="btn-icon" viewBox="0 0 24 24" width="24" height="24">
              <path fill="currentColor" d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M10,16.5L16,12L10,7.5V16.5Z"/>
            </svg>
            Execute Pose Detection
          </button>
        </div>

        <!-- Processing Animation -->
        <div class="processing-animation hidden" id="processingAnimation">
          <div class="ascii-progress">
            <div class="progress-label">PROCESSING:</div>
            <div class="progress-bar-ascii">
              <span id="progressBar">[░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░]</span>
              <span class="progress-percent" id="progressPercent">0%</span>
            </div>
            <div class="frame-counter">
              Processing frame <span id="currentFrame">0</span>/<span id="totalFrames">0</span>
            </div>
          </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
          <div class="results-title">[SUCCESS] PROCESSING COMPLETE</div>

          <!-- Video Player -->
          <div class="video-player-container" id="videoPlayerContainer">
            <video class="result-video" id="resultVideo" muted autoplay loop playsInline>
              <source src="" type="video/mp4">
              Your browser does not support the video tag.
            </video>
          </div>

          <div class="result-stats">
            <div class="result-item">
              <span>Frames Processed:</span>
              <span class="result-value" id="resultFrames">450</span>
            </div>
            <div class="result-item">
              <span>Detection Accuracy:</span>
              <span class="result-value" id="resultAccuracy">96.8%</span>
            </div>
            <div class="result-item">
              <span>Processing Time:</span>
              <span class="result-value" id="resultTime">12.3s</span>
            </div>
            <div class="result-item">
              <span>Output Size:</span>
              <span class="result-value" id="resultSize">8.7 MB</span>
            </div>
          </div>

          <div class="download-section">
            <div class="button-group">
              <button class="action-btn download-btn" id="downloadVideo">
                <svg class="btn-icon" viewBox="0 0 24 24" width="20" height="20">
                  <path fill="currentColor" d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                Download Video
              </button>
              <button class="action-btn download-btn" id="downloadCSV">
                <svg class="btn-icon" viewBox="0 0 24 24" width="20" height="20">
                  <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M10,19L12,15H14L11.5,19H10M18,14H6V12H18V14M18,11H6V9H18V11Z"/>
                </svg>
                Download CSV
              </button>
            </div>
            <button class="action-btn reset-btn" id="resetBtn">
              <svg class="btn-icon" viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/>
              </svg>
              Process Another Video
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Status management
    function updateStatus(state, text, progress = null) {
      // Log the status
      console.log(`[${state.toUpperCase()}] ${text}`, progress ? `(${progress}%)` : '');

      // Update progress bar if progress is provided
      if (progress !== null) {
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');

        if (progressBar && progressPercent) {
          // Calculate filled blocks (50 total characters)
          const filled = Math.floor((progress / 100) * 50);
          const empty = 50 - filled;
          const bar = '[' + '█'.repeat(filled) + '░'.repeat(empty) + ']';

          progressBar.textContent = bar;
          progressPercent.textContent = `${Math.round(progress)}%`;
        }
      }
    }

    // Update status step (simplified)
    function updateStatusStep(stepId, isComplete, text = null) {
      // Just log the step status since we removed the UI components
      console.log(`Step ${stepId}: ${isComplete ? '✓' : '...'} ${text || ''}`);
    }

    // Page initialization
    setTimeout(() => {
      console.log('Upload page ready');
    }, 500);

    // Terminal output helper
    function addOutputLine(text, className = '') {
      const output = document.getElementById('terminalOutput');
      const line = document.createElement('div');
      line.className = `output-line ${className}`;
      line.textContent = text;
      output.appendChild(line);
      output.scrollTop = output.scrollHeight;
    }

    // File handling
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileDisplay = document.getElementById('fileDisplay');
    const processBtn = document.getElementById('processBtn');
    const removeBtn = document.getElementById('removeBtn');
    const detailsToggle = document.getElementById('detailsToggle');
    const fileDetails = document.getElementById('fileDetails');
    let selectedFile = null;

    // Details toggle functionality
    detailsToggle?.addEventListener('click', () => {
      const isExpanded = !fileDetails.classList.contains('hidden');
      if (isExpanded) {
        fileDetails.classList.add('hidden');
      } else {
        fileDetails.classList.remove('hidden');
      }
      detailsToggle.classList.toggle('expanded');
      detailsToggle.innerHTML = isExpanded ?
        '<span class="toggle-icon">▼</span> Show Details' :
        '<span class="toggle-icon">▼</span> Hide Details';
    });

    // Drag and drop
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    });

    // File input
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
      }
    });

    // Handle file
    function handleFile(file) {
      updateStatus('processing', `Analyzing file: ${file.name}`);

      // Validate
      const validTypes = ['video/mp4', 'video/quicktime', 'video/x-msvideo'];
      if (!validTypes.includes(file.type)) {
        updateStatus('error', 'Invalid file format. Use MP4, MOV, or AVI.');
        return;
      }

      if (file.size > 50 * 1024 * 1024) {
        updateStatus('error', 'File exceeds 50MB limit.');
        return;
      }

      selectedFile = file;

      // Display file info
      document.getElementById('fileName').textContent = file.name;
      document.getElementById('fileSize').textContent = formatFileSize(file.size);

      // Create video element to get metadata
      const video = document.createElement('video');
      video.src = URL.createObjectURL(file);
      video.addEventListener('loadedmetadata', () => {
        document.getElementById('fileDuration').textContent = formatDuration(video.duration);
        document.getElementById('fileResolution').textContent = `${video.videoWidth}x${video.videoHeight}`;

        if (video.duration > 15) {
          updateStatus('warning', 'Video exceeds 15s. Will be trimmed.');
          setTimeout(() => {
            updateStatus('success', `File loaded: ${file.name}`);
          }, 2000);
        } else {
          updateStatus('success', `File loaded: ${file.name}`);
        }
      });

      dropZone.classList.add('has-file');
      fileDisplay.style.display = 'block';  // Explicitly show the file display
      fileDisplay.classList.add('show');
      processBtn.classList.remove('hidden');  // Show the process button
    }

    // Remove file
    removeBtn.addEventListener('click', () => {
      selectedFile = null;
      fileDisplay.classList.remove('show');
      fileDisplay.style.display = 'none';
      dropZone.classList.remove('has-file');
      dropZone.style.display = 'block';  // Show drop zone again
      processBtn.classList.add('hidden');  // Hide the process button
      fileInput.value = '';  // Clear the file input so the same file can be selected again
      updateStatus('ready', 'Waiting for video upload');

      // Reset file details
      document.getElementById('fileName').textContent = '';
      document.getElementById('fileSize').textContent = '';
      document.getElementById('fileDuration').textContent = '--:--';
      document.getElementById('fileResolution').textContent = '----x----';
      document.getElementById('fileFrameRate').textContent = '-- fps';
    });

    // Process video
    processBtn.addEventListener('click', async () => {
      console.log('Process button clicked');
      if (!selectedFile) {
        console.log('No file selected');
        return;
      }
      console.log('Selected file:', selectedFile.name, selectedFile.size);

      updateStatus('processing', 'Checking server...');

      // Check API health first
      let health;
      try {
        health = await window.checkAPIHealth(false);
      } catch (error) {
        console.error('Health check error:', error);
        addOutputLine('[ERROR] Failed to check server status', 'error');
        addOutputLine(`> ${error.message}`, 'error');
        // Continue anyway with a basic health object
        health = { healthy: true, coldStart: false, uptime: 0 };
      }

      // Update status based on health check
      if (health.coldStart) {
        updateStatus('warning', 'Server starting up - this may take 30-60 seconds...');
        await new Promise(resolve => setTimeout(resolve, 2000));
      }

      updateStatus('processing', 'Starting pose detection pipeline', 0);

      document.getElementById('processingAnimation').classList.remove('hidden');
      document.getElementById('processingAnimation').classList.add('show');
      processBtn.classList.add('hidden');  // Hide button during processing

      // Process with actual API
      await processVideo();
    });

    // Store current job ID for downloads
    let currentJobId = null;

    // Process video with actual API
    async function processVideo() {
      if (!selectedFile) return;

      const steps = ['step1', 'step2', 'step3', 'step4', 'step5'];
      let processingComplete = false;

      // Initialize frame counter (will be updated from backend)
      let totalFrames = '?';
      let currentFrame = '0';

      // Spinner animation removed (UI component was removed)

      try {
        // Step 1: Upload video
        updateStatus('uploading', 'Uploading video to server...', 0);

        console.log('API URL:', window.API_URL);
        console.log('Upload endpoint:', `${window.API_URL}/api/upload`);

        const formData = new FormData();
        formData.append('file', selectedFile);

        console.log('Sending upload request...');
        const uploadResponse = await fetch(`${window.API_URL}/api/upload`, {
          method: 'POST',
          body: formData
        });
        console.log('Upload response:', uploadResponse.status);

        if (!uploadResponse.ok) {
          throw new Error('Upload failed: ' + await uploadResponse.text());
        }

        const uploadData = await uploadResponse.json();
        currentJobId = uploadData.job_id;

        // Set up cancellation on window close
        const handleBeforeUnload = (e) => {
          if (currentJobId && !processingComplete) {
            // Cancel the job using sendBeacon for reliability
            const cancelUrl = `${window.API_URL}/api/cancel/${currentJobId}`;
            navigator.sendBeacon(cancelUrl);

            // Optional: Show warning to user (most browsers ignore custom messages now)
            e.preventDefault();
            e.returnValue = '';
          }
        };

        window.addEventListener('beforeunload', handleBeforeUnload);

        updateStatusStep('step1', true, '[✓] Upload complete');
        updateStatus('processing', 'Extracting frames...', 25);

        // Step 2-5: Poll for status
        let lastStep = 1;
        while (true) {
          const statusResponse = await fetch(`${window.API_URL}/api/status/${currentJobId}`);
          const status = await statusResponse.json();

          // Update progress based on status
          if (status.status === 'processing') {
            const progress = status.progress || 0;
            updateStatus('processing', `Processing frame ${status.current_frame || '?'}/${status.total_frames || '?'}`, progress);

            // Update the progress bar display
            const filled = Math.floor((progress / 100) * 50);
            const empty = 50 - filled;
            const bar = '[' + '█'.repeat(filled) + '░'.repeat(empty) + ']';
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            if (progressBar) progressBar.textContent = bar;
            if (progressPercent) progressPercent.textContent = `${Math.round(progress)}%`;

            // Update steps based on progress
            if (progress > 24 && lastStep < 2) {
              updateStatusStep('step2', true, '[✓] Frames extracted');
              lastStep = 2;
            }
            if (progress > 75 && lastStep < 3) {
              updateStatusStep('step3', true, '[✓] Pose detection complete');
              lastStep = 3;
            }
            if (progress > 85 && lastStep < 4) {
              updateStatusStep('step4', true, '[✓] Overlay generated');
              lastStep = 4;
            }
            if (progress > 90 && lastStep < 5) {
              updateStatusStep('step5', true, '[✓] Finalizing output');
              updateStatus('processing', 'Finalizing output...', 95);
              lastStep = 5;
            }

            // Update frame counter if available
            if (status.current_frame && status.total_frames) {
              currentFrame = status.current_frame;
              totalFrames = status.total_frames;
              console.log(`Processing frame ${currentFrame}/${totalFrames}`);
            }
          } else if (status.status === 'completed') {
            // All steps complete
            processingComplete = true;
            window.removeEventListener('beforeunload', handleBeforeUnload);

            updateStatusStep('step5', true, '[✓] Processing complete');
            updateStatus('success', 'Processing complete!', 100);

            // Show results
            showResults(status);
            break;
          } else if (status.status === 'failed') {
            updateStatus('error', status.error || 'Processing failed');
            throw new Error('Processing failed: ' + (status.error || 'Unknown error'));
          } else if (status.status === 'cancelled') {
            updateStatus('error', 'Processing cancelled');
            throw new Error('Processing cancelled by user');
          }

          // Wait before next poll
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      } catch (error) {
        processingComplete = true;
        window.removeEventListener('beforeunload', handleBeforeUnload);

        updateStatus('error', error.message);
        processBtn.classList.remove('hidden');  // Show button again on error

        // Mark failed step
        steps.forEach(stepId => {
          const stepEl = document.getElementById(stepId);
          if (stepEl.classList.contains('processing')) {
            stepEl.classList.remove('processing');
            stepEl.classList.add('error');
            stepEl.textContent = '[FAILED] ' + stepEl.textContent;
          }
        });
      }
    }

    // Simulate processing (keep for fallback)
    async function simulateProcessing() {
      const steps = [
        { id: 'step1', text: 'Uploading video to server...', duration: 2000 },
        { id: 'step2', text: 'Extracting frames...', duration: 3000 },
        { id: 'step3', text: 'Running MediaPipe detection...', duration: 5000 },
        { id: 'step4', text: 'Generating skeleton overlay...', duration: 3000 },
        { id: 'step5', text: 'Compressing output...', duration: 1000 }
      ];

      const totalFrames = Math.floor(Math.random() * 200 + 300);
      console.log(`Total frames: ${totalFrames}`);

      // Spinner animation removed (UI component was removed)

      let progress = 0;
      for (let i = 0; i < steps.length; i++) {
        const step = steps[i];
        const stepEl = document.getElementById(step.id);
        stepEl.classList.add('processing');
        stepEl.textContent = step.text;

        // Update progress bar
        const progressInterval = setInterval(() => {
          progress = Math.min(progress + 2, ((i + 1) / steps.length) * 100);
          updateStatus('processing', `Processing frame ${Math.floor((progress / 100) * totalFrames)}/${totalFrames}`, progress);

          // Update frame counter
          const currentFrame = Math.floor((progress / 100) * totalFrames);
          console.log(`Frame ${currentFrame}/${totalFrames}`);
        }, step.duration / 50);

        await new Promise(resolve => setTimeout(resolve, step.duration));
        clearInterval(progressInterval);

        stepEl.classList.remove('processing');
        stepEl.classList.add('success');
        stepEl.textContent = `[OK] ${step.text.replace('...', '')} - Complete`;
        addOutputLine(`[OK] Step ${i + 1}/${steps.length} complete`, 'success');
      }

      showResults();
    }


    // Show results
    function showResults(status) {
      // Hide elements that are no longer needed
      const systemInfo = document.getElementById('systemInfo');
      const fileDisplay = document.getElementById('fileDisplay');
      const processingAnimation = document.getElementById('processingAnimation');

      if (systemInfo) systemInfo.style.display = 'none';
      if (fileDisplay) fileDisplay.style.display = 'none';
      if (processingAnimation) processingAnimation.style.display = 'none';

      // Use actual results from API or fallback to estimates
      const totalFramesCount = status?.total_frames || totalFrames;
      const accuracy = status?.accuracy || (90 + Math.random() * 8).toFixed(1);
      const processingTime = status?.processing_time || (10 + Math.random() * 5).toFixed(1);
      const outputSize = status?.output_size || selectedFile.size * 1.2;

      document.getElementById('resultFrames').textContent = totalFramesCount;
      document.getElementById('resultAccuracy').textContent =
        typeof accuracy === 'number' ? accuracy.toFixed(1) + '%' : accuracy + '%';
      document.getElementById('resultTime').textContent =
        typeof processingTime === 'number' ? processingTime.toFixed(1) + 's' : processingTime + 's';
      document.getElementById('resultSize').textContent =
        typeof outputSize === 'number' ? formatFileSize(outputSize) : outputSize;

      // Set up video player and download buttons
      if (currentJobId) {
        // Load video in player
        const videoPlayer = document.getElementById('resultVideo');
        const videoUrl = `${window.API_URL}/api/download/${currentJobId}/video`;
        videoPlayer.src = videoUrl;

        // Ensure video plays automatically
        videoPlayer.addEventListener('loadeddata', () => {
          videoPlayer.play().catch(err => {
            console.log('Auto-play prevented:', err);
          });
        }, { once: true });

        // Set up download buttons
        const videoBtn = document.getElementById('downloadVideo');
        const csvBtn = document.getElementById('downloadCSV');

        videoBtn.onclick = () => {
          const link = document.createElement('a');
          link.href = videoUrl;
          link.download = `processed_${selectedFile.name}`;
          link.click();
        };

        csvBtn.onclick = () => {
          const link = document.createElement('a');
          link.href = `${window.API_URL}/api/download/${currentJobId}/csv`;
          link.download = `pose_data_${selectedFile.name.replace(/\.[^/.]+$/, '')}.csv`;
          link.click();
        };
      }

      document.getElementById('resultsSection').classList.add('show');

      // Status is already updated to success in the processing loop

      // Scroll to results
      document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
    }

    // Reset
    document.getElementById('resetBtn')?.addEventListener('click', () => {
      location.reload();
    });

    // Utility functions
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function formatDuration(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
  </script>
</body>
</html>